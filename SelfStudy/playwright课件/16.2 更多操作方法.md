### 16.2.1 执行JavaScript代码
Playwright 中可以使用 `page.evaluate` 方法来执行 JavaScript 代码。这个方法非常强大，因为它允许我们在浏览器上下文中直接运行任意的 JavaScript 代码，并且能够获取到执行结果。这对于需要直接操作 DOM 或者执行复杂的 JavaScript 逻辑的场景来说，简直太有用了。

 	`page.evaluate`方法的第一个参数是一个字符串，里面包含了我们想要执行的 JavaScript 代码。此外，我们还可以传递额外的参数到 JavaScript 代码中，以便在执行过程中使用这些参数。

下面是一个具体的例子，展示了如何使用 `page.evaluate` 方法来获取页面的 body 内容：

```python
# 使用page对象执行js
print(page.evaluate("() => document.body"))
```

**参数**

+ 第一个参数是一个字符串，包含要执行的JavaScript代码。
+ 可以传递额外的参数到JavaScript代码中。

**返回值**

+ 返回JavaScript代码执行的结果。

**示例**

```python
from playwright.sync_api import sync_playwright

with sync_playwright() as p:
  browser = p.chromium.launch(headless=False)
  page = browser.new_page()
  page.goto("https://www.baidu.com")

  # 使用page对象执行js
  body_content = page.evaluate("() => document.body.innerHTML")
  print("页面的body内容：", body_content)

  browser.close()
```

在这个例子中，我们首先启动了 Playwright 并打开了一个新的浏览器页面，然后导航到了`https://www.baidu.com`。接着，我们使用 `page.evaluate` 方法执行了一段 JavaScript 代码，这段代码会获取页面的 body 内容，并将其作为结果返回。最后，我们将获取到的内容打印出来，并关闭了浏览器。

### 16.2.2 滚动到元素可见
在很多时候我们需要确保某个元素在视口中可见，以便进行后续操作。Playwright 提供了多种方法来实现这一需求，下面我将详细介绍两种常用的方法。

**方式一: 通过定位的方法滚动到元素可见**

Playwright 提供了一个非常方便的方法 `scroll_into_view_if_needed()`，可以用来滚动页面，使指定的元素在视口中可见。这个方法会检查元素是否已经在视口中，如果不在，则会自动滚动页面，使其可见。

以下是一个具体的例子

**示例：**

```python
from playwright.sync_api import sync_playwright

# 启动 Playwright 并打开一个新的浏览器实例
with sync_playwright() as p:
    browser = p.chromium.launch(headless=False)  # 设置 headless=False 可以看到浏览器界面
    page = browser.new_page()
    page.goto("https://www.baidu.com")  # 导航到指定的网页

    # 定位到需要滚动到视口中的元素
    element = page.query_selector("#su")  # 替换为实际的元素选择器
    element.scroll_into_view_if_needed()  # 滚动页面使元素可见

    # 进行其他操作
    print("元素已经滚动到视口中")

    # 关闭浏览器
    browser.close()

```

在这个例子中，我们首先启动了 Playwright 并打开了一个新的浏览器页面，然后导航到了`https://www.baidu.com`。接着，我们使用 `query_selector `方法定位到了需要滚动到视口中的元素，并调用了 `scroll_into_view_if_needed()` 方法来滚动页面，使其可见。最后，我们进行了其他操作，并关闭了浏览器。



**方式二: 通过 JavaScript 代码来滚动到元素可见**

除了使用 Playwright 提供的方法外，我们还可以通过执行 JavaScript 代码来滚动到元素可见。这可以通过 `page.evaluate` 方法来实现。

以下是一个具体的例子：

```python
from playwright.sync_api import sync_playwright

# 启动 Playwright 并打开一个新的浏览器实例
with sync_playwright() as p:
    browser = p.chromium.launch(headless=False)  # 设置 headless=False 可以看到浏览器界面
    page = browser.new_page()
    page.goto("https://www.baidu.com")  # 导航到指定的网页

    # 定位到需要滚动到视口中的元素
    element = page.query_selector("#su")  # 替换为实际的元素选择器

    # 使用 JavaScript 代码滚动页面使元素可见
    page.evaluate("(element) => element.scrollIntoView({ behavior: 'smooth', block: 'center' });", element)

    # 进行其他操作
    print("元素已经滚动到视口中")

    # 关闭浏览器
    browser.close()

```

在这个例子中，我们同样启动了 Playwright 并打开了一个新的浏览器页面，然后导航到了`www.baidu.com`。接着，我们使用 `query_selector`方法定位到了需要滚动到视口中的元素，并使用 `page.evaluate` 方法执行了一段 JavaScript 代码，这段代码会滚动页面，使元素在视口中居中显示。最后，我们进行了其他操作，并关闭了浏览器。

这两种方法都可以有效地确保元素在视口中可见，你可以根据具体的需求选择合适的方法。

### 16.2.3 注入初始化脚本
`add_init_script`方法允许我们在每个新页面加载之前注入JavaScript代码。这对于修改JavaScript环境非常有用，例如隐藏自动化工具的痕迹。

```python
# 设置初始化js脚本
js = "Object.defineProperties(navigator, {webdriver:{get:()=>undefined}});"
page.add_init_script(js)
```

**参数**

+ 第一个参数是一个字符串，包含要注入的JavaScript代码。

**用途**

+ 修改 `navigator` 对象：避免被检测到自动化工具。
+ 设置全局变量或函数：在页面中定义一些全局变量或函数。
+ 执行其他初始化操作：在页面加载之前执行其他必要的初始化操作。

下面是一个具体的例子，展示了如何使用 `add_init_script` 方法来修改 `navigator` 对象，以避免被检测到自动化工具：

```python
  from playwright.sync_api import sync_playwright

  with sync_playwright() as p:
      browser = p.chromium.launch(headless=False)
      page = browser.new_page()

      # 设置初始化js脚本
      js = "Object.defineProperties(navigator, { webdriver: { get: () => undefined } });"
      page.add_init_script(js)

      page.goto("https://www.taobao.com")

      browser.close()
  
```

在这个例子中，我们首先启动了 Playwright 并打开了一个新的浏览器页面。接着，我们使用 `add_init_script` 方法注入了一段 JavaScript 代码，这段代码会修改 navigator 对象，使其不显示 webdriver 属性，从而避免被检测到自动化工具。然后，我们导航到了 [https://www.taobao.com](https://www.taobao.com)，并进行了其他操作。最后，我们关闭了浏览器。

**其他用途示例**

除了修改 navigator 对象外，我们还可以使用 `add_init_script` 方法来设置全局变量或函数。以下是一个示例

```python
from playwright.sync_api import sync_playwright

# 启动 Playwright 并打开一个新的浏览器实例
with sync_playwright() as p:
    browser = p.chromium.launch(headless=False)  # 设置 headless=False 可以看到浏览器界面
    page = browser.new_page()

    # 设置初始化 js 脚本，定义一个全局函数
    js = """
    function myGlobalFunction() {
        console.log('This is a global function');
    }
    """
    page.add_init_script(js)

    # 导航到指定的网页
    page.goto("https://www.taobao.com")

    # 使用注入的全局函数
    page.evaluate("myGlobalFunction()")

    # 进行其他操作
    print("初始化脚本已注入，页面已加载")

    # 关闭浏览器
    browser.close()

```

在这个例子中，我们注入了一段 JavaScript 代码，定义了一个全局函数 `myGlobalFunction`。然后，我们在页面加载后使用 `page.evaluate` 方法调用了这个全局函数。通过这些示例，希望大家能够更好地理解和使用 `add_init_script` 方法

### 16.2.4 嵌套的iframe元素 处理
接下来我们一起来了解如何在 Playwright 中处理嵌套的 iframe 元素。在处理包含 iframe 的网页时，`frame_locator` 方法非常有用，它允许我们在 iframe 中定位和操作元素。下面我将详细介绍如何使用这些方法

```python
# 练习网站：https://qzone.qq.com/
locator = page.frame_locator("#my-iframe").get_by_text("Submit")
locator.click()
```

**参数**

+ `frame_locator`: 定位到指定的iframe元素。
+ `get_by_text`: 在iframe中查找文本内容。
+ `click`: 模拟点击操作。

**用途**

+ 在iframe中定位元素。
+ 在iframe中执行各种操作，如点击、输入等。

**示例**

下面是一个具体的例子，展示了如何使用 `frame_locator` 方法在 iframe 中定位并点击一个元素。我们将以一个练习网站 [https://qzone.qq.com/](https://qzone.qq.com/) 为例。

```python
from playwright.sync_api import sync_playwright

with sync_playwright() as p:
  browser = p.chromium.launch(headless=False)
  page = browser.new_page()
  page.goto("https://qzone.qq.com/")

  # 切换到iframe并点击元素
  locator = page.frame_locator("#my-iframe").get_by_text("Submit")
  locator.click()

  browser.close()
```

在这个例子中，我们首先启动了 Playwright 并打开了一个新的浏览器页面，然后导航到了 [https://qzone.qq.com/](https://qzone.qq.com/)。接着，我们使用 `frame_locator` 方法定位到了 ID 为 my-iframe 的 iframe 元素，并在其中查找包含文本 "Submit" 的元素。最后，我们模拟点击了这个元素，并关闭了浏览器。

